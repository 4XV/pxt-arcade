<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://www.facebook.com/2008/fbml">

<head>
	<meta charset="UTF-8">
	<title>@name@</title>

	<!-- @include meta.html -->

	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport"
		content="width=device-width,height=device-height,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">

	<link rel="stylesheet" href="./static/script-page.css" />

	<link rel="alternate" type="application/json+oembed" href="@oembedurl@&format=json" />
	<link rel="alternate" type="text/xml+oembed" href="@oembedurl@&format=xml" />

	<style>
		/* fix for iOS; see https://github.com/PierBover/ios-iframe-fix */
		#wrap {
			position: fixed;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
			overflow-y: hidden;
			-webkit-overflow-scrolling: touch;
		}

		html {
			width: 100%;
			height: 100%;
			overflow: hidden;
		}

		body {
			height: 100%;
		}

		#wrap iframe {
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
		}
	</style>
	<style id="injected-style">
	</style>
</head>

<body id='root' class='root expandIt share-page'>

	<!-- @include macros.html -->

	<div class="ui main container mainbody script-content">
		<div id="wrap">
			<div class="simframe ui embed">
				<iframe id="simframe" title="Simulator" allowfullscreen="" allow="autoplay"
					sandbox="allow-same-origin allow-scripts" class="no-select" src="/sim/simulator.html"
					frameborder="0">
				</iframe>
			</div>
		</div>

		<script type="text/javascript">
			(function () {
				var code = "";
				var isReady = false;
				var simState = {}
				var simStateChanged = false
			
				function fetchCode() {
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function () {
						if (xhttp.readyState == 4 && xhttp.status == 200) {
							code = xhttp.responseText;
							startSim();
						}
					};
					xhttp.open("GET", "/api/@id@/js?v=@simversion@", true);
					xhttp.send();
				}

				function startSim() {
					if (!code || !isReady)
						return
					const runMsg = {
						type: "run",
						parts: [],
						"code": code,
						partDefinitions: {},
						cdnUrl: "/cdn/",
						version: "lean:@id@",
						storedState: simState,
						frameCounter: 1,
						options: {
							"theme": "green",
							"player": ""
						},
						"id": "green-" + Math.random()
					}
					const frame = document.getElementById("simframe");
					frame.contentWindow.postMessage(runMsg, "*");
				}

				fetchCode()

				try {
					simState = JSON.parse(localStorage["sim-@id@"])
				} catch (e) {
					simState = {}
				}
				setInterval(function () {
					if (simStateChanged)
						localStorage["sim-@id@"] = JSON.stringify(simState)
					simStateChanged = false
				}, 200)
				
				window.addEventListener('message', function (ev) {
					var d = ev.data
					if (d.type == "ready") {
						isReady = true;
						startSim();
					} else if (d.type == "simulator") {
						switch (d.command) {
							case "restart":
								startSim();
								break;
							case "setstate":
								simState[d.stateKey] = d.stateValue
								simStateChanged = true
								break;
						}
					} else {
						console.log(d)
					}
				}, false);
			})()
		</script>

	</div>

	<!-- @include tracking.html -->
</body>

</html>